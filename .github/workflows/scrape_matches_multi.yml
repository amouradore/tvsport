name: Update Daily Matches from Icastresana

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Download eventos.m3u from Icastresana
        run: |
          curl -o eventos.m3u https://raw.githubusercontent.com/Icastresana/lista1/main/eventos.m3u
          echo "Downloaded eventos.m3u: $(wc -l < eventos.m3u) lines"
      
      - name: Show script info
        run: |
          echo "=== Script generate_matches.py ==="
          head -50 scripts/generate_matches.py
          echo ""
          echo "=== Checking EXCLUDED ==="
          grep -A5 "EXCLUDED" scripts/generate_matches.py | head -10
      
      - name: Run generate_matches.py
        run: |
          python3 scripts/generate_matches.py
          echo ""
          echo "=== Generated files ==="
          echo "matches.json: $(cat matches.json | python3 -c 'import json,sys; d=json.load(sys.stdin); print(len(d), \"matches\")')"
          echo "matches_other.json: $(cat matches_other.json | python3 -c 'import json,sys; d=json.load(sys.stdin); print(len(d), \"matches\")')"
      
      - name: Display competitions
        run: |
          echo "=== Competitions in matches.json ==="
          cat matches.json | python3 -c "import json,sys; d=json.load(sys.stdin); comps={}
for m in d: comps[m['competition']]=comps.get(m['competition'],0)+1
for c,n in sorted(comps.items()): print(f'  {c}: {n}')"
          echo ""
          echo "=== Competitions in matches_other.json ==="
          cat matches_other.json | python3 -c "import json,sys; d=json.load(sys.stdin); comps={}
for m in d: comps[m['competition']]=comps.get(m['competition'],0)+1
for c,n in sorted(comps.items()): print(f'  {c}: {n}')"
      
      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add matches.json matches_other.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update matches - $(date '+%Y-%m-%d %H:%M:%S')" && git push)