name: Update Daily Matches from Icastresana

on:
  # schedule:
  #   - cron: '*/10 * * * *'  # DISABLED - fix script first
  workflow_dispatch:  # Manual only for now

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Download eventos.m3u from Icastresana
        run: |
          curl -o eventos.m3u https://raw.githubusercontent.com/Icastresana/lista1/main/eventos.m3u
          echo "Downloaded eventos.m3u: $(wc -l < eventos.m3u) lines"
      
      - name: List logos folder
        run: |
          echo "=== Logos folder ==="
          ls -la logos/ | head -20
          echo ""
          echo "=== Spain LaLiga logos ==="
          ls "logos/Spain - LaLiga/" | head -10
      
      - name: Run generate_matches.py with debug
        run: |
          echo "=== Running script ==="
          python3 scripts/generate_matches.py
          echo ""
          echo "=== Results ==="
          echo "matches.json:"
          python3 -c "import json; d=json.load(open('matches.json')); print(f'  Count: {len(d)}'); comps={}
for m in d: comps[m['competition']]=comps.get(m['competition'],0)+1
for c,n in sorted(comps.items()): print(f'  {c}: {n}')"
          echo ""
          echo "matches_other.json:"
          python3 -c "import json; d=json.load(open('matches_other.json')); print(f'  Count: {len(d)}'); comps={}
for m in d: comps[m['competition']]=comps.get(m['competition'],0)+1
for c,n in sorted(comps.items()): print(f'  {c}: {n}')"
      
      - name: Show sample logos
        run: |
          echo "=== Sample logos in matches.json ==="
          python3 -c "import json; d=json.load(open('matches.json'))
for m in d[:3]:
  print(f\"{m['home_team']} vs {m['away_team']}\")
  print(f\"  Home: {m['home_logo']}\")
  print(f\"  Away: {m['away_logo']}\")"
      
      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add matches.json matches_other.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update matches - $(date '+%Y-%m-%d %H:%M:%S')" && git push)